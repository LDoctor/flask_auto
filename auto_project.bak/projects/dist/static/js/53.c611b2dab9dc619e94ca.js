webpackJsonp([53],{"/qHr":function(e,t){},hREQ:function(e,t){},meT7:function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=o("3cXf"),a=o.n(n),l=o("1JPr"),s=o("aA9S"),i=o.n(s),r={name:"pana-create-department",components:{"pana-info":o("yRx0").a},props:{show:Boolean,gpu:Object},watch:{"form.currentPool":function(e){null!=e&&""!==e&&this.getComponentList(e),this.$refs.form.clearValidate("componentId")},"form.componentId":function(e){var t=this;this.components.map(function(o){e===o.uid&&(t.currentComponent=o)})}},methods:{closeModal:function(e){e=e||!1,i()(this.$data,this.$options.data.call(this)),this.$emit("closeModal",e)},initForm:function(){null!=this.$refs.form&&this.$refs.form.clearValidate(),this.getPoolList()},getPoolList:function(){var e=this;this.loading=!0,this.checkError(this.$http({url:this.api.cloud.get_pools+"?size=1000",method:"get"}),function(t){e.pools=t.data.filter(function(e){return e.status<2}),t.data.length>0&&(e.form.currentPool=t.data[0].id,e.getPoolStorageServer()),e.loading=!1},function(){e.loading=!1})},getComponentList:function(e){var t=this;this.loading=!0,t.components=[],t.form.componentId="",this.checkError(this.$http({url:this.common.formatMsg(this.api.cloud.get_gpu_pool_detail_check,{id:e}),method:"get"}),function(o){parseInt(o.data)>0?(t.emptyQuota=!1,t.checkError(t.$http({url:t.common.formatMsg(t.api.cloud.get_pools_detail_servers,{pool_id:e}),method:"get"}),function(e){t.components=e.data.filter(function(e){return e.hostName===t.gpu.host&&("SHUTOFF"===e.status||"ACTIVE"===e.status)&&t.storageServer!==e.uid&&"fixedImageInstanceName"!==e.name}),e.data.length>0&&(t.currentComponent=t.components[0],t.form.componentId=t.currentComponent.uid),t.loading=!1},function(){t.loading=!1})):(t.emptyQuota=!0,t.loading=!1)},function(){t.loading=!1})},loadGpu:function(){var e=this;this.disable=!0,this.$refs.form.validate(function(t){if(t){var o={};o.bus=e.gpu.bus,o.description=e.gpu.description,o.deviceType=e.gpu.deviceType,o.function=e.gpu.function,o.gpuId=e.gpu.gpuId,o.host=e.gpu.host+".node.consul",o.slot=e.gpu.slot,o.serverId=e.currentComponent.uid,o.serverName=e.currentComponent.name,o.migrate=!1,e.checkError(e.$http({url:e.api.cloud.gpu_load,method:"post",data:{meta:[o]}}),function(){e.$notify({title:e.lang.common.success,type:"success",message:e.lang.gpuManage.loadingGpu}),e.wsEventQueue.push(e.gpu.gpuId+e.currentComponent.uid),e.closeModal(!0),e.disable=!1},function(){e.closeModal(!1),e.disable=!1})}else e.disable=!1})},getPoolStorageServer:function(){var e=this;this.pools.map(function(t){t.id===e.form.currentPool&&(e.storageServer=t.stor_server_id)})}},data:function(){return{labelWidth:"100px",storageServer:null,pools:[],components:[],currentComponent:{},form:{currentPool:"",componentId:""},rules:{currentPool:[{required:!0,message:this.lang.gpuManage.requiredRule,trigger:"blur"}],componentId:[{required:!0,message:this.lang.gpuManage.requiredRule,trigger:"blur"}]},disable:!1,loading:!0,emptyQuota:!1}}},u={render:function(){var e=this,t=e.$createElement,o=e._self._c||t;return o("el-dialog",{attrs:{title:e.lang.gpuManage.load,width:"30%",visible:e.show,modal:!0},on:{open:e.initForm,close:e.closeModal}},[o("el-form",{directives:[{name:"loading",rawName:"v-loading",value:e.loading,expression:"loading"}],ref:"form",attrs:{"label-position":"right",model:e.form,rules:e.rules,"element-loading-text":e.lang.common.loading,"element-loading-spinner":"el-icon-loading","element-loading-background":"rgb(255, 255, 255)"}},[o("el-row",{attrs:{type:"flex",justify:"center"}},[o("el-col",{attrs:{span:20}},[o("el-form-item",{attrs:{label:e.lang.gpuManage.selectPool,"label-width":e.labelWidth,prop:"currentPool"}},[o("el-select",{attrs:{filterable:"",placeholder:e.lang.gpuManage.poolSelectPlaceholder,width:"100%"},on:{change:e.getPoolStorageServer},model:{value:e.form.currentPool,callback:function(t){e.$set(e.form,"currentPool",t)},expression:"form.currentPool"}},e._l(e.pools,function(e,t){return o("el-option",{key:t,attrs:{label:e.name,value:e.id}})}),1)],1)],1)],1),e._v(" "),o("el-row",{attrs:{type:"flex",justify:"center"}},[o("el-col",{attrs:{span:20}},[o("el-form-item",{attrs:{label:e.lang.gpuManage.selectComponent,"label-width":e.labelWidth,prop:"componentId"}},[o("el-select",{attrs:{filterable:"",placeholder:e.lang.gpuManage.componentSelectPlaceholder,width:"100%"},model:{value:e.form.componentId,callback:function(t){e.$set(e.form,"componentId",t)},expression:"form.componentId"}},e._l(e.components,function(e,t){return o("el-option",{key:t,attrs:{label:e.name,value:e.uid}})}),1)],1)],1)],1),e._v(" "),o("pana-info",{directives:[{name:"show",rawName:"v-show",value:e.emptyQuota,expression:"emptyQuota"}],attrs:{content:e.lang.gpuManage.quotaInfo,bgStyle:"error"}})],1),e._v(" "),o("span",{staticClass:"dialog-footer",attrs:{slot:"footer"},slot:"footer"},[o("el-button",{on:{click:e.closeModal}},[e._v(e._s(e.lang.common.cancel))]),e._v(" "),o("el-button",{attrs:{type:"primary"},on:{click:e.loadGpu}},[e._v(e._s(e.lang.common.confirm))])],1)],1)},staticRenderFns:[]};var c=o("C7Lr")(r,u,!1,function(e){o("zT3O"),o("hREQ")},"data-v-2279052a",null).exports,p={name:"pana-unload-gpu",props:{show:Boolean,gpu:Object},data:function(){return{vm:{},loading:!1}},methods:{closeModal:function(e){e=e||!1,"SHUTOFF"!==this.vm.status&&(e=!1),this.$emit("closeModal",e)},init:function(){this.getComponentDetail()},deleteDepartment:function(){this.closeModal(!0)},getComponentDetail:function(){var e=this;null!=this.gpu&&(this.loading=!0,this.checkError(this.$http({url:this.common.formatMsg(this.api.cloud.get_pool_servers_detail,{server_id:this.gpu.server_id}),method:"get"}),function(t){e.loading=!1,e.vm=t.data},function(){e.loading=!1}))}}},g={render:function(){var e=this,t=e.$createElement,o=e._self._c||t;return o("el-dialog",{attrs:{title:e.lang.common.info,visible:e.show,width:"30%",modal:!0},on:{open:e.init,close:e.closeModal}},[o("el-row",{directives:[{name:"loading",rawName:"v-loading",value:e.loading,expression:"loading"}],attrs:{type:"flex",justify:"center","element-loading-text":e.lang.common.loading,"element-loading-spinner":"el-icon-loading","element-loading-background":"rgb(255, 255, 255)"}},[o("el-col",{attrs:{span:12}},[e._v(e._s("SHUTOFF"===e.vm.status?e.lang.gpuManage.unloadGpuInfo:e.common.formatMsg(e.lang.gpuManage.unloadShutdownWarning,{componentName:e.vm.name})))])],1),e._v(" "),o("span",{staticClass:"dialog-footer",attrs:{slot:"footer"},slot:"footer"},[o("el-button",{on:{click:e.closeModal}},[e._v(e._s(e.lang.common.cancel))]),e._v(" "),o("el-button",{attrs:{type:"primary"},on:{click:e.deleteDepartment}},[e._v(e._s(e.lang.common.confirm))])],1)],1)},staticRenderFns:[]},d=o("C7Lr")(p,g,!1,null,null,null).exports,m={name:"gpu-manage",components:{"pana-breadcrumb":l.a,"pana-load-gpu":c,"pana-unload-gpu":d},computed:{gpuFilter:function(){var e=this;return this.gpuOrigin.filter(function(t){return""===e.gpuSearch||-1!==a()(t).search(e.gpuSearch)})},gpuTable:function(){return this.gpuFilter.length>this.pageSize?this.gpuFilter.slice((this.gpuPage-1)*this.pageSize,this.gpuPage*this.pageSize):this.gpuFilter}},data:function(){return{pageSize:10,gpuSearch:"",gpuPage:1,gpuSelections:[],gpuOrigin:[],showLoadGpu:!1,showUnloadGpu:!1,loadConf:{unload:{style:"cloud-btn-gray",title:this.lang.gpuManage.unloaded},load:{style:"cloud-btn-green",title:this.lang.gpuManage.loaded},preload:{style:"cloud-btn-purple",title:this.lang.gpuManage.preload}},loading:!1}},methods:{sortChange:function(e){var t=null==e.order?0:"ascending"===e.order?1:-1;this.gpuOrigin=this.gpuOrigin.sort(function(o,n){return o[e.prop]=null==o[e.prop]?"":o[e.prop],n[e.prop]=null==n[e.prop]?"":n[e.prop],(o[e.prop]>n[e.prop]?1:-1)*t})},switchGpuPage:function(e){this.gpuPage=e},selectGpu:function(e){this.gpuSelections=e},getGpuList:function(){var e=this;this.loading=!0,this.checkError(this.$http({url:this.api.cloud.gpu_device_list,method:"get"}),function(t){e.loading=!1,e.gpuOrigin=t.data},function(){e.loading=!1})},closeUnloadGpu:function(e){var t=this;this.showUnloadGpu=!1,!0===e&&(this.checkError(this.$http({url:this.api.cloud.gpu_unload,method:"post",data:{function:this.gpuSelections[0].function,slot:this.gpuSelections[0].slot,gpuId:this.gpuSelections[0].gpuId,bus:this.gpuSelections[0].bus,server_id:this.gpuSelections[0].server_id}}),function(){t.$notify({title:t.lang.common.success,type:"success",message:t.lang.gpuManage.unloadGpuSuccess}),t.getGpuList()}),t.gpuSelections=[])},closeLoadGpu:function(e){this.showLoadGpu=!1,!0===e&&this.getGpuList()}},mounted:function(){var e=this;this.getGpuList(),this.$ws.setCallback(function(t){var o=e.wsEventQueue.indexOf(t.resource_id),n=t.event_type.split(".");-1!==o&&"udsafe"===n[0]&&"gpu"===n[2]&&"end"===n[4]&&e.getGpuList()})}},h={render:function(){var e=this,t=e.$createElement,o=e._self._c||t;return o("el-container",{attrs:{type:"flex",direction:"vertical"}},[o("pana-breadcrumb"),e._v(" "),o("el-main",[o("el-row",{staticClass:"pana-btn-group",attrs:{type:"flex",justify:"space-between"}},[o("el-col",{attrs:{span:12}},[o("el-button",{attrs:{disabled:1!==e.gpuSelections.length||"load"===e.gpuSelections[0].gpu_status||"preload"===e.gpuSelections[0].gpu_status},on:{click:function(t){e.showLoadGpu=!0}}},[e._v("\n                    "+e._s(e.lang.gpuManage.load)+"\n                ")]),e._v(" "),o("el-button",{attrs:{disabled:1!==e.gpuSelections.length||"unload"===e.gpuSelections[0].gpu_status||"preload"===e.gpuSelections[0].gpu_status},on:{click:function(t){e.showUnloadGpu=!0}}},[e._v("\n                    "+e._s(e.lang.gpuManage.unload)+"\n                ")])],1),e._v(" "),o("el-col",{attrs:{span:6}},[o("el-row",{staticClass:"search-row",attrs:{type:"flex",justify:"space-around"}},[o("el-col",{attrs:{span:22}},[o("el-input",{attrs:{placeholder:e.lang.common.search,"suffix-icon":"el-icon-search"},model:{value:e.gpuSearch,callback:function(t){e.gpuSearch=t},expression:"gpuSearch"}})],1),e._v(" "),o("el-col",{attrs:{span:2}},[o("el-button",{staticClass:"fa fa-refresh",attrs:{type:"text",circle:""},on:{click:e.getGpuList}})],1)],1)],1)],1),e._v(" "),o("el-table",{directives:[{name:"loading",rawName:"v-loading",value:e.loading,expression:"loading"}],ref:"multipleTable",staticClass:"cloud-table",staticStyle:{width:"100%"},attrs:{"element-loading-text":e.lang.common.loading,"element-loading-spinner":"el-icon-loading","element-loading-background":"rgb(255, 255, 255)",data:e.gpuTable,"tooltip-effect":"dark"},on:{"selection-change":e.selectGpu,"sort-change":e.sortChange}},[o("el-table-column",{attrs:{type:"selection"}}),e._v(" "),o("el-table-column",{attrs:{label:e.lang.gpuManage.deviceName,sortable:"custom",prop:"gpuId"},scopedSlots:e._u([{key:"default",fn:function(t){return[o("el-tooltip",{staticClass:"item",attrs:{effect:"dark",content:t.row.description,placement:"top"}},[o("span",[e._v("\n                            "+e._s(t.row.gpuId)+"\n                        ")])])]}}])}),e._v(" "),o("el-table-column",{attrs:{label:e.lang.gpuManage.physicHost,sortable:"custom",prop:"host"}}),e._v(" "),o("el-table-column",{attrs:{label:e.lang.gpuManage.poolName,sortable:"custom",prop:"pool_name"}}),e._v(" "),o("el-table-column",{attrs:{label:e.lang.gpuManage.componentName,sortable:"custom",prop:"server_name"}}),e._v(" "),o("el-table-column",{attrs:{label:e.lang.gpuManage.isLoaded,sortable:"custom",prop:"loading"},scopedSlots:e._u([{key:"default",fn:function(t){return[o("span",{class:["status",e.loadConf[t.row.gpu_status.toLowerCase()].style]},[e._v("\n                        "+e._s(e.loadConf[t.row.gpu_status.toLowerCase()].title)+"\n                    ")])]}}])})],1),e._v(" "),o("el-row",{staticClass:"pana-pagination-row",attrs:{type:"flex",justify:"end"}},[e.gpuFilter.length>e.pageSize?o("el-pagination",{attrs:{background:"",layout:"slot, prev, pager, next","prev-text":e.lang.common.prevPage,"next-text":e.lang.common.nextPage,total:e.gpuFilter.length,"page-size":e.pageSize},on:{"current-change":e.switchGpuPage}},[e._t("default",[o("span",{staticClass:"pagination-slot"},[e._v("\n                        "+e._s(e.common.formatMsg(e.lang.common.paginationMsg,{current:this.gpuPage,total:this.gpuFilter.length}))+"\n                    ")])])],2):e._e()],1),e._v(" "),o("pana-load-gpu",{attrs:{show:e.showLoadGpu,gpu:e.gpuSelections[0]},on:{closeModal:e.closeLoadGpu}}),e._v(" "),o("pana-unload-gpu",{attrs:{show:e.showUnloadGpu,gpu:e.gpuSelections[0]},on:{closeModal:e.closeUnloadGpu}})],1)],1)},staticRenderFns:[]};var f=o("C7Lr")(m,h,!1,function(e){o("/qHr")},"data-v-0809e48c",null);t.default=f.exports},zT3O:function(e,t){}});